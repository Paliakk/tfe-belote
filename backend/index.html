<!DOCTYPE html>
<html lang="fr">

<head>
    <base href="./">
    <meta charset="UTF-8">
    <title>Test Socket.IO - Belote</title>
    <style>
        body {
            font-family: sans-serif;
            background: #fafafa;
            padding: 1em;
        }

        button {
            margin: 4px;
        }

        #log {
            background: #222;
            color: #0f0;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }

        #membres-list {
            margin-top: 1em;
            padding: 0;
            list-style: none;
            border: 1px solid #ccc;
            max-width: 300px;
            background: white;
            min-height: 100px;
        }

        #membres-list li {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
        }

        #membres-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <h1>Test WebSocket Belote</h1>
    <button onclick="connect()">üîê Se connecter</button>
    <button onclick="createLobby()">üé≤ Cr√©er lobby</button>
    <button onclick="joinLobbyByName()">Rejoindre par nom</button>
    <button onclick="leaveLobby()">Quitter lobby</button>
    <button onclick="startGame()">Lancer la partie</button>
    <button onclick="chat()">üí¨ Chat lobby</button>
    <button onclick="clearLogs()">üßπ Nettoyer logs</button>

    <h2>Membres du lobby</h2>
    <ul id="membres-list"></ul>

    <h2>Logs</h2>
    <pre id="log"></pre>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket;
        let currentLobbyId = null;

        const logEl = () => document.getElementById('log');
        const listEl = () => document.getElementById('membres-list');
        const FRONTEND_ORIGIN = window.location.origin;

        socket.on('partie:started', ({ partieId, mancheId }) => {
            const url = `${FRONTEND_ORIGIN}/game.html?partieId=${encodeURIComponent(partieId)}`
                + (mancheId ? `&mancheId=${encodeURIComponent(mancheId)}` : '');
            window.location.assign(url);
        });
        function log(msg) {
            logEl().textContent += msg + '\n';
            console.log(msg);
        }
        function clearLogs() { logEl().textContent = ''; }

        function renderMembers(membres = []) {
            const el = listEl();
            el.innerHTML = '';
            membres.forEach(m => {
                const li = document.createElement('li');
                li.textContent = `${m.username} (ID: ${m.id})`;
                el.appendChild(li);
            });
        }

        function connect() {
            const token = prompt('Entrez votre token Auth0 :');
            if (!token) return log('‚ùå Aucun token fourni.');
            localStorage.setItem('auth_token', token);

            socket = io('http://localhost:3000', { auth: { token } });

            socket.on('connect', () => log('‚úÖ Connect√© au serveur WS'));
            socket.on('connect_error', err => log('‚ùå Erreur connexion : ' + err.message));

            // on stocke l‚ÄôID du lobby d√®s qu‚Äôon le re√ßoit
            socket.on('lobby:joined', ({ lobbyId }) => {
                currentLobbyId = lobbyId;
                log(`üéâ Lobby rejoint avec ID: ${currentLobbyId}`);
            });

            // ‚Äî‚Äî‚Äî Rendu pilot√© par l‚Äô√©tat ‚Äî‚Äî‚Äî
            socket.on('lobby:state', ({ lobbyId, membres }) => {
                currentLobbyId = currentLobbyId ?? lobbyId;
                log(`üì¶ State lobby ${lobbyId} ‚Äî ${membres.length} membre(s)`);
                renderMembers(membres);
            });

            // En bonus: petit event court pour les logs UX
            socket.on('lobby:update', ({ lobbyId, type, joueur }) => {
                log(`üì¢ ${type === 'join' ? '‚ûï' : '‚ûñ'} ${joueur} (${type}) dans lobby ${lobbyId}`);
            });

            socket.on('lobby:closed', ({ lobbyId }) => {
                log(`üö™ Lobby ${lobbyId} ferm√©/supprim√©`);
                renderMembers([]); // clean
                currentLobbyId = null;
            });

            // ‚Äî‚Äî‚Äî Redirection quand la partie d√©marre ‚Äî‚Äî‚Äî
            socket.on('lobby:gameStarted', ({ partieId }) => {
                // construit une URL relative au fichier courant (respecte /backend/)
                const url = new URL('game.html', window.location.href);
                url.searchParams.set('partieId', String(partieId));
                window.location.assign(url.toString());
            });
        }

        // ‚Äî‚Äî‚Äî Boutons ‚Äî‚Äî‚Äî
        function createLobby() {
            const nom = prompt('Nom du lobby √† cr√©er ?') || 'Lobby Test';
            socket.emit('lobby:create', { nom }, (res) => {
                if (res?.lobbyId) {
                    currentLobbyId = res.lobbyId;
                    log(`üéâ Lobby cr√©√©: ${currentLobbyId}`);
                }
            });
            log('üîπ Emit lobby:create');
        }

        function joinLobbyByName() {
            const nom = prompt('Nom du lobby ?') || 'test';
            socket.emit('lobby:joinByName', { nom });
            log('üîπ Emit lobby:joinByName');
        }

        function leaveLobby() {
            if (!currentLobbyId) return log('‚ö†Ô∏è Aucun lobby en cours.');
            socket.emit('lobby:leaveRoom', { lobbyId: currentLobbyId });
            log('üîπ Emit lobby:leaveRoom');
        }

        function chat() {
            if (!currentLobbyId) return log('‚ö†Ô∏è Aucun lobby');
            const message = prompt('Message √† envoyer :');
            if (!message) return;
            socket.emit('lobby:chat', { lobbyId: currentLobbyId, message });
            log('üîπ Emit lobby:chat');
        }

        function startGame() {
            if (!socket || !socket.connected) {
                log('‚ö†Ô∏è Non connect√© au WS');
                return;
            }

            // Utilise l‚ÄôID courant si on l‚Äôa, sinon demande-le √† l‚Äôutilisateur
            const id = currentLobbyId ?? parseInt(prompt('ID du lobby ?'), 10);
            if (!id) {
                log('‚ùå Aucun lobbyId fourni.');
                return;
            }

            const scoreMax = parseInt(prompt('Score max (ex: 301) ?', '301'), 10) || 301;

            socket.emit('lobby:startGame', { lobbyId: id, scoreMax });
            log(`üîπ Emit lobby:startGame { lobbyId: ${id}, scoreMax: ${scoreMax} }`);
        }
    </script>
</body>

</html>